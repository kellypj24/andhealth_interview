version: 2

models:
  - name: int_340b_entities_with_addresses
    description: >
      Intermediate model combining covered entities with their associated addresses (billing, shipping, and street).
      Each entity has up to three address types normalized into separate columns for easier downstream consumption.
    
    columns:
      # Core Entity Fields
      - name: ce_id
        description: Unique identifier for the covered entity
        tests:
          - unique
          - not_null

      - name: id_340b
        description: Official 340B program ID for the covered entity
        tests:
          - not_null
          - unique

      - name: entity_name
        description: Legal name of the covered entity
        tests:
          - not_null

      - name: entity_type
        description: Type code for the covered entity (e.g., BL for Black Lung)
        tests:
          - not_null
          - accepted_values:
              values: ['BL', 'CH', 'DS', 'FQ', 'HC', 'HM', 'HR', 'RH', 'TB']

      - name: sub_name
        description: Sub-entity or facility name if applicable

      - name: is_participating
        description: Flag indicating if entity is currently participating in 340B program
        tests:
          - not_null

      - name: participating_start_date
        description: Date when entity began participating in 340B program
        tests:
          - not_null:
              where: "is_participating = true"

      # Billing Address Fields
      - name: billing_address_line1
        description: Primary billing address line
        tests:
          - not_null:
              where: "is_participating = true"

      - name: billing_address_line2
        description: Secondary billing address line

      - name: billing_city
        description: City for billing address
        tests:
          - not_null:

      - name: billing_state
        description: State code for billing address
        tests:
          - not_null:
              where: "billing_address_line1 is not null"
          - relationships:
              to: ref('seed_state_codes')
              field: state_code

      - name: billing_zip
        description: ZIP code for billing address
        tests:
          - not_null:

      - name: billing_organization
        description: Organization name for billing purposes

      # Shipping Address Fields
      - name: shipping_address_line1
        description: Primary shipping address line

      - name: shipping_address_line2
        description: Secondary shipping address line

      - name: shipping_city
        description: City for shipping address
        tests:
          - not_null:

      - name: shipping_state
        description: State code for shipping address
        tests:
          - not_null:

      - name: shipping_zip
        description: ZIP code for shipping address
        tests:
          - not_null:

      - name: shipping_is_340b_address
        description: Boolean flag indicating if shipping address is registered 340B location
        tests:
          - accepted_values:
              values: [true, false]

      # Street Address Fields
      - name: street_address_line1
        description: Primary street address line
        tests:
          - not_null:

      - name: street_address_line2
        description: Secondary street address line

      - name: street_city
        description: City for street address
        tests:
          - not_null:

      - name: street_state
        description: State code for street address
        tests:
          - not_null:

      - name: street_zip
        description: ZIP code for street address
        tests:
          - not_null:
              where: "street_address_line1 is not null"

      # Metadata Fields
      - name: loaded_at
        description: Timestamp when record was loaded into the warehouse
        tests:
          - not_null

      - name: source_edited_at
        description: Timestamp when record was last edited in source system
        tests:
          - not_null

    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('stg_covered_entities')
      - dbt_utils.recency:
          field: loaded_at
          datepart: day
          interval: 1