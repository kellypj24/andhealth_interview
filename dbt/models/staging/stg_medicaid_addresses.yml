version: 2

models:
  - name: stg_medicaid_addresses
    description: >
      Staging model for addresses associated with medicaid entities. Includes billing,
      shipping, and street addresses. Each record represents a unique address for a
      medicaid entity.
    
    columns:
      - name: medicaid_address_id
        description: Surrogate key generated from parent_ce_id, ce_id, address_type, and address_line1
        tests:
          - unique
          - not_null

      - name: parent_ce_id
        description: Foreign key to the parent covered entity
        tests:
          - not_null

      - name: parent_id_340b
        description: The 340B ID of the parent covered entity
        tests:
          - not_null

      - name: ce_id
        description: The medicaid entity ID this address belongs to
        tests:
          - not_null

      - name: id_340b
        description: The 340B ID of the medicaid entity
        tests:
          - not_null

      - name: address_type
        description: The type of address (billing, shipping, or street)
        tests:
          - not_null
          - accepted_values:
              values: ['billing', 'shipping', 'street']

      - name: address_line1
        description: Primary address line
        tests:
          - not_null

      - name: address_line2
        description: Secondary address line (optional)

      - name: city
        description: City
        tests:
          - not_null

      - name: state
        description: State code
        tests:
          - not_null
          - accepted_values:
              values: ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 
                      'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 
                      'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 
                      'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 
                      'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY', 
                      'DC', 'PR', 'VI', 'GU', 'AS', 'MP']

      - name: zip
        description: ZIP code
        tests:
          - not_null

      - name: zip4
        description: ZIP+4 code (optional)

      - name: organization
        description: Organization name (only for billing addresses)

      - name: is_340b_street_address
        description: Flag indicating if this is a 340B street address (only for shipping addresses)
        tests:
          - not_null

      - name: _loaded_at
        description: Timestamp when the record was loaded into the raw table
        tests:
          - not_null

      - name: dbt_loaded_at
        description: Timestamp when this record was loaded into the staging table
        tests:
          - not_null

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - parent_ce_id
            - ce_id
            - address_type
            - address_line1